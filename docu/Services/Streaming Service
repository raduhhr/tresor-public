# ðŸŽµ Nginx-Music â€” Public Jellyfin Streaming via VPS Reverse Proxy

## Overview

Nginx-Music is Tresor's **public media streaming layer** â€” an nginx reverse proxy on the VPS that forwards HTTPS traffic through the WireGuard tunnel to a dedicated Jellyfin instance (`jellyfin-music`) on the home node.

This exists because **Cloudflare Tunnel's TOS prohibits video/audio streaming traffic**. Rather than risking a CF account ban, all media streaming bypasses Cloudflare entirely and goes through the VPS directly with Let's Encrypt TLS.

| Component | Host | Role | Network |
| --- | --- | --- | --- |
| **Nginx** | `tresor-vps` | TLS termination + reverse proxy | public (ports 80, 443) |
| **WireGuard** | `tresor-vps` â†” `tresor` | Encrypted tunnel | WG subnet |
| **Jellyfin-Music** | `tresor` | Dedicated streaming instance | `bridge` + `internal_net`, bound to WG client interface |

```
Browser / App
    â†“ HTTPS (443)
<music_domain> (VPS public IP)
    â†“ nginx reverse proxy
    â†“ TLS terminated (Let's Encrypt)
WireGuard tunnel (VPS â†’ Tresor)
    â†“ HTTP
jellyfin-music container (Tresor)
```

> **Key distinction:** This is a completely separate Jellyfin instance from the LAN-only `jellyfin` container. The LAN instance serves the full media library on the local network. The public instance (`jellyfin-music`) is locked to the WireGuard interface and only accessible through the VPS.

---

## Why Not Cloudflare Tunnel?

Cloudflare's [Self-Serve Subscription Agreement Â§2.8](https://www.cloudflare.com/terms/) prohibits using their network to serve disproportionate amounts of non-HTML content â€” specifically video and audio streaming. While enforcement varies, violating TOS risks account termination, which would take down all other services routed through the tunnel (Uptime Kuma, landing site, etc.).

The VPS reverse proxy solution:

- **No CF dependency** for streaming traffic
- **Direct TLS** via Let's Encrypt (no CF edge involved)
- **Same WireGuard tunnel** already in use for Minecraft
- **Minimal cost** â€” VPS already paid for

---

## Runtime Profile

| Setting | Value |
| --- | --- |
| **Domain** | `{{ nginx_music_domain }}` |
| **TLS** | Let's Encrypt via Certbot (nginx plugin) |
| **Upstream** | `{{ wg_client_ip }}:{{ nginx_music_upstream_port }}` (over WireGuard) |
| **Nginx config** | `/etc/nginx/sites-available/music.conf` |
| **Cert path** | `/etc/letsencrypt/live/{{ nginx_music_domain }}/` |
| **Managed by** | `roles/nginx-music` |
| **Rate limiting** | Configurable per-endpoint (general + strict tiers) |
| **Connection limit** | Configurable per-IP concurrent connections |
| **Max upload** | `{{ nginx_music_max_body }}` |
| **HSTS** | Enabled |

---

## Role Behavior (`roles/nginx-music`)

### Deployment flow:

1. Installs `nginx`, `certbot`, `python3-certbot-nginx`
2. Opens UFW ports 80/443
3. Renders HTTP-only bootstrap config (for ACME challenge)
4. Issues Let's Encrypt cert via `certbot --nginx`
5. Renders full TLS config with security hardening
6. Reloads nginx

### Pre-flight:

- Probes the upstream backend over WireGuard before deploying
- Warns (but continues) if backend unreachable â€” allows cert issuance even if Tresor is temporarily down

### Config templates:

- `music.http.nginx.j2` â€” minimal HTTP config for initial cert issuance
- `music.tls.nginx.j2` â€” full production config with TLS, rate limiting, security headers, and API blocking

---

## Security Model

### Network layer

- Nginx listens on VPS public IP (ports 80/443 only)
- All traffic to Jellyfin goes through encrypted WireGuard tunnel
- `jellyfin-music` is bound exclusively to the WG client interface â€” unreachable from LAN or public internet
- UFW on VPS uses default-deny with explicit allowlist for required ports only

### Application layer (nginx hardening)

**Rate limiting:**

- General requests: configurable rate with burst allowance
- Strict endpoints (login, websockets): tighter rate with minimal burst

**Connection limits:**

- Configurable max concurrent connections per IP

**Security headers:**

- `X-Frame-Options: SAMEORIGIN`
- `X-Content-Type-Options: nosniff`
- `X-XSS-Protection: 1; mode=block`
- `Referrer-Policy: no-referrer`
- `Permissions-Policy` â€” disables unnecessary browser APIs
- Content Security Policy tuned for Jellyfin UI

**API hardening:**

- Sensitive Jellyfin API endpoints (system info, user enumeration, admin interfaces, direct file downloads) are blocked at the nginx level
- Only safe HTTP methods are allowed (GET, POST, HEAD, OPTIONS)
- Unauthenticated API enumeration is prevented

**Logging:**

- Blocked and denied requests are logged to dedicated files for monitoring

---

## Container Profile (`jellyfin-music`)

| Setting | Value |
| --- | --- |
| **Container name** | `jellyfin-music` |
| **Image** | `jellyfin/jellyfin:latest` |
| **Bind address** | WG client interface only |
| **Networks** | `bridge`, `internal_net` |
| **Media** | Same library as LAN Jellyfin (mounted RO) |
| **Config** | Separate config dir from LAN instance |

> This is a dedicated instance with its own config, users, and playback state. It shares the media library via read-only mounts but is otherwise fully isolated from the LAN Jellyfin.

---

## Packet Flow (detailed)

```
Client (phone/browser)
    â†“ DNS: <music_domain> â†’ <VPS_PUBLIC_IP>
    â†“ TCP 443 (HTTPS)
VPS nginx (TLS termination)
    â†“ rate limit + security headers + API blocking
    â†“ proxy_pass http://<wg_client_ip>:<upstream_port>
WireGuard tunnel (encrypted UDP)
    â†“ VPS (wg server) â†’ Tresor (wg client)
Tresor â€” jellyfin-music container
    â†“ bound to WG interface only
    â†“ serves media from HDD (RO mount)
```

---

## Relationship to Other Services

| Service | Access | Notes |
| --- | --- | --- |
| **jellyfin** (LAN) | LAN IP only | Full media server, LAN-only, VAAPI HW accel |
| **jellyfin-music** (public) | WG interface via VPS | Public streaming, WG-only, nginx TLS frontend |
| **Cloudflare Tunnel** | `*.domain` (non-streaming) | Web apps only â€” no media traffic |
| **Velocity** (MC) | VPS public port | Shares VPS but completely separate |

> **No streaming traffic touches Cloudflare.** Web services go through CF Tunnel â†’ Traefik. Media streaming goes through VPS nginx â†’ WireGuard â†’ jellyfin-music. These paths are fully independent.

---

## Troubleshooting

| Symptom | Likely Cause | Fix |
| --- | --- | --- |
| 502 Bad Gateway | WireGuard tunnel down or jellyfin-music stopped | `sudo wg show` on both nodes; `docker ps` on tresor |
| Cert renewal fails | Port 80 blocked or nginx misconfigured | `sudo certbot renew --dry-run`; check UFW |
| Slow playback / buffering | WG latency or bandwidth cap | Check `wg show` transfer stats; test with `iperf3` |
| 403 on API endpoints | nginx blocks sensitive paths by design | Expected behavior â€” check blocked request logs |
| Rate limited (429) | Too many requests from single IP | Adjust rate limit vars in role defaults |
| "Connection refused" in nginx logs | jellyfin-music not bound to WG IP | Verify `docker inspect jellyfin-music` shows correct WG binding |
| HSTS causing issues on HTTP | Browser cached strict-transport-security | Clear HSTS in browser; ensure cert is valid |

---

## Maintenance

| Task | Command |
| --- | --- |
| Deploy/update | `ansible-playbook -i inventory/hosts.ini playbooks/vps/deploy-nginx-music.yml` |
| Check nginx status | `ssh tresor-vps 'sudo systemctl status nginx'` |
| View nginx config | `ssh tresor-vps 'cat /etc/nginx/sites-available/music.conf'` |
| Test nginx config | `ssh tresor-vps 'sudo nginx -t'` |
| Check cert expiry | `ssh tresor-vps 'sudo certbot certificates'` |
| Force cert renewal | `ssh tresor-vps 'sudo certbot renew --force-renewal'` |
| View blocked requests | `ssh tresor-vps 'tail -50 /var/log/nginx/jellyfin_blocked.log'` |
| View error log | `ssh tresor-vps 'tail -50 /var/log/nginx/error.log'` |
| Restart nginx | `ssh tresor-vps 'sudo systemctl restart nginx'` |

---

## Gotchas

- **Certbot modifies nginx config** â€” the `--nginx` plugin rewrites the server block during issuance. The Ansible role handles this by rendering the TLS template *after* cert issuance, overwriting certbot's changes with the hardened config.
- **Cert auto-renewal** â€” certbot installs a systemd timer (`certbot.timer`) that handles renewal automatically. The nginx plugin reloads nginx after renewal.
- **Two Jellyfin instances, separate configs** â€” don't confuse `jellyfin` (LAN) with `jellyfin-music` (WG). They have independent databases, users, and playback states.
- **DNS must point directly to VPS** â€” the music domain needs an A record to the VPS IP, **NOT** proxied through Cloudflare (orange cloud off). CF proxying would re-introduce the TOS issue.
- **VPS bandwidth** â€” monitor usage if streaming heavily. Check your provider's included traffic allowance.

---

*Last validated: February 2026*
*Document path: `/docu/Tresor/Services/nginx-music/Overview.md`*
