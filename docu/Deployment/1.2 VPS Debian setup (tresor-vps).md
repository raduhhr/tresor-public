


# VPS Setup — tresor-vps (Edge Node)

This node serves as Tresor’s external edge — a minimal Debian server hosting:

- The WireGuard server (`10.8.0.1`)
- The Velocity Minecraft proxy (public port `25565`)
- Fail2Ban and UFW for host protection

Unlike the main Tresor node, it does not run Docker — all services are installed directly via systemd units and managed with Ansible.

---

## 1. VPS Provisioning

Steps (manual, one-time):

1. Create a new VPS instance on your hosting provider (for example, a CX22-class plan, region Germany).  
2. Select image: **Debian 13 (bookworm)**.  
3. Add your SSH key from the workstation for initial access.  
4. Disable provider backups (Ansible handles snapshot backups later).  
5. Boot and confirm SSH access:
   ```bash
   ssh root@203.0.113.50


---

## 2. Bootstrap the VPS with `init-tresor-vps.sh`

On your workstation:

```bash
scp scripts/init-tresor-vps.sh root@203.0.113.50:/tmp/
ssh root@203.0.113.50 'bash /tmp/init-tresor-vps.sh'
```

This script:

* Creates the `ansible` user with NOPASSWD sudo
* Disables root login and password authentication
* Installs base dependencies (`sudo`, `python3`, `rsync`, `curl`, `ufw`, `fail2ban`)
* Applies minimal SSH and security hardening identical to the home node

Verify SSH access:

```bash
ssh ansible@203.0.113.50
sudo -n true && echo "OK"
```

---

## 3. Run VPS Base Setup via Ansible

Playbook:

```bash
ansible-playbook -i inventory/hosts.ini playbooks/vps/setup-base.yml
```

Tasks:

* Configures system timezone and hostname (`tresor-vps`)
* Ensures UFW and Fail2Ban are active
* Closes all inbound ports except `22`, `51820`, and `25565`
* Installs essential system tools

---

## 4. Deploy WireGuard Server

Playbook:

```bash
ansible-playbook -i inventory/hosts.ini playbooks/vps/setup-wireguard.yml
```

Tasks:

* Creates `/etc/wireguard/wg0.conf` from template
* Assigns IP `10.8.0.1/24`
* Enables forwarding and iptables rules
* Starts and enables the WireGuard systemd service

Verify:

```bash
ssh ansible@tresor-vps 'sudo wg show'
```

Expected peer: `10.8.0.2` (Tresor home node) connected.

---

## 5. Deploy Velocity Proxy

Playbook:

```bash
ansible-playbook -i inventory/hosts.ini playbooks/vps/setup-velocity.yml
```

Tasks:

* Installs Velocity in `/opt/velocity`
* Deploys templated `velocity.toml` and `servers.toml`
* Exposes port `25565/tcp` publicly via UFW
* Creates and enables `velocity.service`
* Uses a forwarding secret managed via Ansible Vault

Verify:

```bash
sudo systemctl status velocity
ss -tlnp | grep 25565
```

---

## 6. Validate Connectivity End-to-End

From your local workstation or Minecraft client:

* Ping `10.8.0.1` (WireGuard server)
* Ping `10.8.0.2` (Tresor home node)
* Connect to Minecraft via `203.0.113.50:25565`
  (traffic is tunneled via WireGuard → Paper backend)

---

## Final VPS State

| Component        | Status                | Notes                                        |
| ---------------- | --------------------- | -------------------------------------------- |
| WireGuard Server | Active                | `10.8.0.1` peer connected                    |
| Velocity Proxy   | Running               | Forwards traffic to Paper (`10.8.0.2:25565`) |
| UFW / Fail2Ban   | Enabled               | Protects SSH and Velocity port               |
| Docker           | Not Installed         | Bare-metal setup                             |
| Public exposure  | Only port `25565/tcp` | No HTTP services exposed                     |

---

**Result:**
`tresor-vps` operates as a hardened, minimal edge node that handles secure Minecraft proxying and WireGuard tunneling, forming the public entry point for the Tresor infrastructure.

```
